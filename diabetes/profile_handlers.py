"""Handlers related to patient profile management."""

from __future__ import annotations

from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler

from diabetes.db import SessionLocal, Profile
from diabetes.ui import menu_keyboard
from .common_handlers import commit_session

PROFILE_ICR, PROFILE_CF, PROFILE_TARGET = range(0, 3)


async def profile_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Set patient profile coefficients via ``/profile`` command."""
    args = context.args
    if len(args) != 3:
        await update.message.reply_text(
            "‚ùó –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã:\n"
            "/profile <–ò–ö–• –≥/–µ–¥.> <–ö–ß –º–º–æ–ª—å/–ª> <—Ü–µ–ª–µ–≤–æ–π>\n"
            "–ü—Ä–∏–º–µ—Ä: /profile 10 2 6",
            parse_mode="Markdown",
        )
        return

    try:
        icr = float(args[0].replace(",", "."))
        cf = float(args[1].replace(",", "."))
        target = float(args[2].replace(",", "."))
    except ValueError:
        await update.message.reply_text(
            "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞. –ü—Ä–∏–º–µ—Ä:\n/profile 10 2 6",
            parse_mode="Markdown",
        )
        return

    if icr <= 0 or cf <= 0 or target <= 0:
        await update.message.reply_text(
            "‚ùó –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–æ–ª—å—à–µ 0. –ü—Ä–∏–º–µ—Ä:\n/profile 10 2 6",
            parse_mode="Markdown",
        )
        return

    warning_msg = ""
    if icr > 8 or cf < 3:
        warning_msg = (
            "\n‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞: –≤–æ–∑–º–æ–∂–Ω–æ, –≤—ã –ø–µ—Ä–µ–ø—É—Ç–∞–ª–∏ –º–µ—Å—Ç–∞–º–∏ –ò–ö–• –∏ –ö–ß.\n"
            f"‚Ä¢ –í—ã –≤–≤–µ–ª–∏ –ò–ö–• = {icr} –≥/–µ–¥. (–≤—ã—Å–æ–∫–æ–≤–∞—Ç–æ)\n"
            f"‚Ä¢ –ö–ß = {cf} –º–º–æ–ª—å/–ª (–Ω–∏–∑–∫–æ–≤–∞—Ç–æ)\n\n"
            "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–µ–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:\n"
            f"/profile {cf} {icr} {target}\n"
        )

    user_id = update.effective_user.id
    with SessionLocal() as session:
        prof = session.get(Profile, user_id)
        if not prof:
            prof = Profile(telegram_id=user_id)
            session.add(prof)

        prof.icr = icr
        prof.cf = cf
        prof.target_bg = target
        commit_session(session)

    await update.message.reply_text(
        f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω:\n"
        f"‚Ä¢ –ò–ö–•: {icr} –≥/–µ–¥.\n"
        f"‚Ä¢ –ö–ß: {cf} –º–º–æ–ª—å/–ª\n"
        f"‚Ä¢ –¶–µ–ª–µ–≤–æ–π —Å–∞—Ö–∞—Ä: {target} –º–º–æ–ª—å/–ª" + warning_msg,
        parse_mode="Markdown",
    )


async def profile_view(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Display current patient profile."""
    context.user_data.clear()
    user_id = update.effective_user.id
    with SessionLocal() as session:
        profile = session.get(Profile, user_id)

    if not profile:
        await update.message.reply_text(
            "–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.\n\n"
            "–ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n"
            "/profile <–ò–ö–• –≥/–µ–¥.> <–ö–ß –º–º–æ–ª—å/–ª> <—Ü–µ–ª–µ–≤–æ–π>\n"
            "–ü—Ä–∏–º–µ—Ä: /profile 10 2 6",
            parse_mode="Markdown",
        )
        return

    msg = (
        "üìÑ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n"
        f"‚Ä¢ –ò–ö–•: {profile.icr} –≥/–µ–¥.\n"
        f"‚Ä¢ –ö–ß: {profile.cf} –º–º–æ–ª—å/–ª\n"
        f"‚Ä¢ –¶–µ–ª–µ–≤–æ–π —Å–∞—Ö–∞—Ä: {profile.target_bg} –º–º–æ–ª—å/–ª"
    )
    await update.message.reply_text(msg)


async def profile_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Cancel profile creation conversation."""
    await update.message.reply_text("–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=menu_keyboard)
    return ConversationHandler.END


__all__ = [
    "PROFILE_ICR",
    "PROFILE_CF",
    "PROFILE_TARGET",
    "profile_command",
    "profile_view",
    "profile_cancel",
]
